---
- name: Install kubernetes Python library
  ansible.builtin.apt:
    name: python3-kubernetes
    state: present
  become: true

- name: Add Traefik Helm repository
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://traefik.github.io/charts
  become: false
  run_once: true

- name: Install Traefik via Helm
  kubernetes.core.helm:
    name: traefik
    chart_ref: traefik/traefik
    chart_version: "{{ traefik_chart_version | default(omit, true) }}"
    release_namespace: "{{ traefik_namespace }}"
    create_namespace: true
    wait: true
    values:
      persistence:
        enabled: true

      securityContext:
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532

      podSecurityContext:
        fsGroup: 65532

      env: >-
        {{
          [
            {'name': 'RFC2136_NAMESERVER', 'value': traefik_rfc2136_host ~ ':' ~ traefik_rfc2136_port},
            {'name': 'RFC2136_TSIG_KEY', 'value': traefik_rfc2136_tsig_keyname},
            {'name': 'RFC2136_TSIG_ALGORITHM', 'value': traefik_rfc2136_tsig_algorithm},
            {'name': 'RFC2136_TSIG_SECRET', 'value': traefik_rfc2136_tsig_secret}
          ] if traefik_acme_challenge == 'dns' else []
        }}

      certificatesResolvers:
        letsencrypt:
          acme:
            email: "{{ traefik_acme_email }}"
            storage: "{{ traefik_acme_storage }}"
            caServer: "{{ traefik_acme_server }}"
            dnsChallenge: "{{ {'provider': 'rfc2136'} if traefik_acme_challenge == 'dns' else omit }}"
            httpChallenge: "{{ {'entryPoint': 'web'} if traefik_acme_challenge == 'http' else omit }}"

      service:
        type: "{{ traefik_service_type }}"
        spec:
          loadBalancerIP: "{{ traefik_loadbalancer_ip | default(omit) }}"

      dashboard:
        enabled: "{{ traefik_dashboard_enabled }}"

      ingressClass:
        enabled: true
        isDefaultClass: true
        name: "{{ traefik_ingress_class }}"
      
      ports:
        web:
          redirections:
            entryPoint:
              to: websecure
              scheme: https

      providers:
        kubernetesIngress:
          ingressEndpoint:
            ip: "{{ traefik_public_ip }}"
  become: false
  run_once: true

- name: Create www redirect Middleware
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: www-redirect
        namespace: "{{ traefik_namespace }}"
      spec:
        redirectRegex:
          regex: "^https?://www\\.(.+)"
          replacement: "https://${1}"
          permanent: true
  become: false
  run_once: true

- name: Create www redirect IngressRoute
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: www-redirect
        namespace: "{{ traefik_namespace }}"
      spec:
        entryPoints:
          - web
          - websecure
        routes:
          - match: "Host(`www.{{ frikanalen_domain }}`)"
            kind: Rule
            middlewares:
              - name: www-redirect
            services:
              - name: noop@internal
                kind: TraefikService
        tls:
          certResolver: letsencrypt
  become: false
  run_once: true

- name: Wait for Traefik to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ traefik_namespace }}"
    name: traefik
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 120
  become: false
  run_once: true
