- name: Wait for MicroK8s to be ready
  ansible.builtin.command: microk8s status --wait-ready
  environment:
    PATH: "/snap/bin:{{ ansible_env.PATH | default('/usr/bin:/bin') }}"
  become: true
  changed_when: false

- name: Get kubeconfig from MicroK8s
  ansible.builtin.command: microk8s config
  environment:
    PATH: "/snap/bin:{{ ansible_env.PATH | default('/usr/bin:/bin') }}"
  become: true
  register: microk8s_config
  changed_when: false

- name: Ensure .kube directories exist for users
  ansible.builtin.file:
    path: "/home/{{ item.username }}/.kube"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0700"
  loop: "{{ microk8s_kubectl_users }}"
  become: true

- name: Write kubeconfig for users
  ansible.builtin.copy:
    content: "{{ microk8s_config.stdout }}"
    dest: "/home/{{ item.username }}/.kube/{{ microk8s_kubeconfig_filename }}"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0600"
  loop: "{{ microk8s_kubectl_users }}"
  become: true
