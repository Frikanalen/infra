---

- name: Ensure zone directory exists with correct ownership
  become: yes
  ansible.builtin.file:
    path: "{{ dns_zone_dir }}"
    state: directory
    owner: bind
    group: bind
    mode: "0755"

- name: Render TSIG key configuration
  become: yes
  ansible.builtin.template:
    src: "tsig-key.conf.j2"
    dest: "{{ dns_named_conf_d }}/tsig-key-{{ dns_dynamic_zone_name }}.conf"
    owner: bind
    group: bind
    mode: "0640"
  no_log: true
  notify: reload named

- name: Render zone configuration
  become: yes
  ansible.builtin.template:
    src: "zones.conf.j2"
    dest: "{{ dns_named_conf_d }}/zones-dynamic.conf"
    owner: bind
    group: bind
    mode: "0644"
  notify: reload named

- name: Render forward zone for {{ dns_dynamic_zone_name }}
  become: yes
  ansible.builtin.template:
    src: "db.staging.frikanalen.no.j2"
    dest: "{{ dns_zone_dir }}/db.{{ dns_dynamic_zone_name }}"
    owner: bind
    group: bind
    mode: "0644"
    force: no  # Don't overwrite if zone has been updated dynamically
  notify: reload named
