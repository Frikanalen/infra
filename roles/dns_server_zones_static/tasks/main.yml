---

- name: Load host definitions
  ansible.builtin.include_vars:
    file: "../data/hosts.yml"
    name: dc1_hosts

- name: Ensure zone directory exists with correct ownership
  become: yes
  ansible.builtin.file:
    path: "{{ dns_zone_dir }}"
    state: directory
    owner: bind
    group: bind
    mode: "0755"

- name: Render zone configuration
  become: yes
  ansible.builtin.template:
    src: "zones.conf.j2"
    dest: "{{ dns_named_conf_d }}/zones-static.conf"
    owner: bind
    group: bind
    mode: "0644"
  notify: reload named

- name: Render forward zone for {{ dns_zone_name }}
  become: yes
  ansible.builtin.template:
    src: "db.dc1.frikanalen.no.j2"
    dest: "{{ dns_zone_dir }}/db.{{ dns_zone_name }}"
    owner: bind
    group: bind
    mode: "0644"
  vars:
    host_entries: "{{ dc1_hosts.host_config }}"
  notify: reload named

- name: Render reverse zones
  become: yes
  ansible.builtin.template:
    src: "db.{{ item }}.j2"
    dest: "{{ dns_zone_dir }}/db.{{ item }}"
    owner: bind
    group: bind
    mode: "0644"
  loop: "{{ dns_reverse_prefixes }}"
  vars:
    host_entries: "{{ dc1_hosts.host_config }}"
  notify: reload named
